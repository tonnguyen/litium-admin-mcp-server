---
title: "Working with discounts"
description: "Important! - following code is only for demonstrating concepts, it is not complete and does not handle all scenarios."
---
Orders may contain discounts, such as shipping fee discounts, fee discounts, product discounts and order level discounts. This section explains how to handle them when constructing data that need to be sent to external tax calculation service.

**Important!** \- following code is only for demonstrating concepts, it is not complete and does not handle all scenarios.

## Product discounts

Your external tax service's API might handle the product level discounts by itself, and if that is so you may be able to simply pass the order rows as received from Litium. However, there are many tax calculation services that expect to receive the final product order row total (ie after all discounts have been applied) to calculate tax. If that is so, you need to reduce the product row amounts with the discount amounts before sending the values to the external tax service API.

Product discount rows can be identified as follows.

```csharp
public static bool IsProductDiscount(this OrderRow discountRow, ICollection<DiscountInfo> discountInfo, out List<string> productRowIds)
{
    productRowIds = null;
    var discount = discountInfo?.FirstOrDefault(x => x.ResultOrderRowId == discountRow.Id);
    if (discount != null && discount.ProductDiscount)
    {
        productRowIds = discount.SourceOrderRowIds.ToList();
        return true;
    }
    return false;
}
```

Now we modify our previous example code to handle Litium order rows that represent product discounts:

```csharp
private async Task<CalculateSalesOrderTaxResponse> CalculateSalesOrderTax(CalculateSalesOrderTaxRequest request)
{
    var response = new CalculateSalesOrderTaxResponse
    {
        TaxRows = new List<TaxRow>()
    };
    foreach (var shippingGroup in request.ShippingGroups)
    {
        var lineItems = new Dictionary<string, TaxServiceLineItem>();

        foreach (var orderRow in shippingGroup.Rows.ToList())
        {
            //.. convert this orderRow to the tax calculation service order rows.

            //Note: Not all order rows are products. Apart from product rows, there are discounts, fees and shipping fees.
            // Depending on the tax calculation service you are using, you might need to find the product discounts, and pro-rata apportion the order level discounts to product rows.
            switch (orderRow.OrderRowType)
            {
                case OrderRowType.Product:
                    if (lineItems.ContainsKey(orderRow.Id))
                    {
                        var lineItem = lineItems[orderRow.Id];
                        lineItem.Amount += orderRow.TotalExcludingTax;
                    }
                    else
                    {
                        lineItems.Add(orderRow.Id, new TaxServiceLineItem
                        {
                            Id = orderRow.Id,
                            Amount = orderRow.TotalExcludingTax,
                            Quantity = (int)orderRow.Quantity,
                            TaxCode = orderRow.TaxData?.TaxCode
                        });
                    }
                    break;
                case OrderRowType.Fee:
                    break;
                case OrderRowType.ShippingFee:
                    break;
                case OrderRowType.Discount:
                    if (orderRow.IsProductDiscount(request.DiscountInfo, out List<string> productRowIds))
                    {
                        //in this example, we assume this product discount refer to only one productRow.
                        //in your implemenation you would need to handle scenarios where multiple product rows are present.
                        var productRowId = productRowIds.FirstOrDefault();
                        if (lineItems.ContainsKey(productRowId))
                        {
                            var lineItem = lineItems[productRowId];
                            lineItem.Amount += orderRow.TotalExcludingTax; //note: for discounts, this is a negative value
                        }
                        else
                        {
                            lineItems.Add(orderRow.Id, new TaxServiceLineItem
                            {
                                Id = orderRow.Id,
                                Amount = orderRow.TotalExcludingTax,
                                Quantity = (int)orderRow.Quantity,
                                TaxCode = orderRow.TaxData?.TaxCode
                            });
                        }
                    }
                    break;
            }
        }

        //...call the tax calculation service, such as Avalara and obtain the calculated tax.
        var taxServiceResponse = ExternalTaxAPI.SimulateCallToExternalTaxService(new TaxServiceRequest { Items = lineItems.Values.ToList() });

        var taxRow = new TaxRow();
        //... construct a taxRow for each shipping group, using tax data received from the tax calculation service.

        response.TaxRows.Add(taxRow);
    }
    return response;
}
```

As you can see above we are reducing the product row amount directly by the product discount applied onto it.

## Shipping and fee discounts

There can be discounts applied to fees and shipping fees. In this case, they are not product discounts, but fee discounts. You can identify them in the following way. Key point is that, SourceOrderRowIds is not null and is pointing to a order row.

```csharp
public static bool IsCampaignDiscount(this OrderRow discountRow, ICollection<DiscountInfo> discountInfo, out List<string> sourceRowIds)
{
    sourceRowIds = null;
    var discount = discountInfo?.FirstOrDefault(x => x.ResultOrderRowId == discountRow.Id);
    if (discount != null && discount.ProductDiscount == false && discount.SourceOrderRowIds?.Count > 0)
    {
        sourceRowIds = discount.SourceOrderRowIds.ToList();
        return true;
    }
    return false;
}
```

How the shipping and fee rows should be presented depend on the tax calculation provider you are using. However, the way to handle it is similar to the way the product discounts are handled above.

## Order level discounts

Order level discounts are discounts applied to the whole order. If the external tax service you are using does not accept these rows directly, you are expected to reduce the product row amounts, proportional to the product values.

Since you need to calculate proportionate amounts, this has to be done after all other calculations are done and allocated.

You may find a order level discount row as follows:

```csharp
public static bool IsOrderDiscount(this OrderRow discountRow, ICollection<DiscountInfo> discountInfo)
{
    var discount = discountInfo?.FirstOrDefault(x => x.ResultOrderRowId == discountRow.Id);
    if (discount != null && discount.ProductDiscount == false && (discount.SourceOrderRowIds is null || discount.SourceOrderRowIds.Count == 0))
    {                
        return true;
    }
    return false;
}
```

### Using discount.PromotionDiscountType

For more specific handling of discounts, you may also use the discount.PromotionDiscountType property. To demonstrate the concept, following sample code omitts shipping rows and shipping discounts as non-taxable. 

```csharp
public static bool IsTaxable(this OrderRow orderRow, ICollection<DiscountInfo> discountInfo)
{
    if (orderRow == null)
        return false;

    return orderRow.OrderRowType switch
    {
        OrderRowType.Tax => false,
        OrderRowType.RoundingOffAdjustment => false,
        OrderRowType.AlternativePaymentMethod => false,
        OrderRowType.ShippingFee => false,
        OrderRowType.Discount => IsDiscountTaxable(orderRow, discountInfo),
        _ => true
    };

    static bool IsDiscountTaxable(OrderRow discountRow, ICollection<DiscountInfo> discountInfo)
    {
        //since shipping fees are not taxed, shipping discounts should not be taxed.
        var discount = discountInfo?.FirstOrDefault(x => x.ResultOrderRowId == discountRow.Id);
        if (discount != null && discount.PromotionDiscountType == "FreeDelivery")
        {
            //since shipping fee is not taxable, the FreeDelivery discount is also not taxable.
            return false;
        }
        //all discounts are taxable by default.
        return true;
    }
}
```
